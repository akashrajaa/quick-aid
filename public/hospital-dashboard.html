<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuikAid Hospital Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', Arial, sans-serif;
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }

    .header h1 {
      color: #059669;
      font-size: 28px;
      font-weight: 700;
    }

    .hospital-info {
      background: #f0fdf4;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
      border-left: 4px solid #059669;
    }

    .data-section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .data-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .data-header h2 {
      color: #1f2937;
      font-size: 22px;
      font-weight: 600;
    }

    .search-box {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .search-input {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      width: 250px;
    }

    .no-data {
      text-align: center;
      color: #6b7280;
      padding: 40px 20px;
      font-size: 16px;
    }

    .emergency-card {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      border: 2px solid #fecaca;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      position: relative;
    }

    .emergency-card.accepted {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-color: #6ee7b7;
    }

    .emergency-type {
      background: #dc2626;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      display: inline-block;
      margin-bottom: 10px;
    }

    .emergency-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }

    .emergency-detail {
      display: flex;
      align-items: center;
      color: #374151;
      font-size: 14px;
    }

    .emergency-detail i {
      margin-right: 8px;
      width: 16px;
      color: #6b7280;
    }

    .refresh-btn {
      background: #059669;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      background: #047857;
      transform: translateY(-1px);
    }

    .hospital-distance-info {
      background: rgba(16, 185, 129, 0.1);
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      border-left: 4px solid #059669;
    }

    .hospital-distance-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .hospital-distance-item {
      background: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      color: #059669;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-online {
      background: #d1fae5;
      color: #059669;
    }

    .status-pending {
      background: #fef3c7;
      color: #d97706;
    }

    .status-completed {
      background: #dbeafe;
      color: #2563eb;
    }

    /* ✅ Animation for incoming patient notifications */
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* ✅ Notification container styles */
    #incomingPatientContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      max-width: 400px;
      pointer-events: none;
    }

    .incoming-patient-notification {
      pointer-events: auto;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 20px;
      }

      .header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }

      .search-input {
        width: 100%;
      }

      .emergency-details {
        grid-template-columns: 1fr;
      }
      
      /* ✅ Mobile responsiveness for notifications */
      #incomingPatientContainer {
        position: fixed !important;
        top: 10px !important;
        left: 10px !important;
        right: 10px !important;
        max-width: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- ✅ Notification container (will be created dynamically) -->
  <div id="incomingPatientContainer"></div>

  <div class="container">
    <div class="header">
      <h1><i class="fas fa-hospital"></i> Hospital Dashboard</h1>
      <div style="display: flex; gap: 10px;">
        <div class="refresh-btn" onclick="refreshData()">
          <i class="fas fa-sync-alt"></i> Refresh Data
        </div>
        <div class="refresh-btn" onclick="testNotification()" style="background: #dc2626;">
          <i class="fas fa-bell"></i> Test Notification
        </div>
      </div>
    </div>

    <div class="hospital-info">
      <strong><i class="fas fa-building"></i> Hospital:</strong> <span id="hospitalName">Loading...</span><br>
      <small><i class="fas fa-info-circle"></i> Monitoring emergency alerts in real-time</small>
    </div>

    <div class="data-section">
      <div class="data-header">
        <h2><i class="fas fa-exclamation-triangle"></i> Emergency Alerts</h2>
        <div class="search-box">
          <input type="text" class="search-input" placeholder="Search emergencies..." id="emergencySearch" oninput="filterEmergencies()">
          <i class="fas fa-search" style="color: #6b7280;"></i>
        </div>
      </div>
      
      <div id="emergenciesContainer">
        <div class="no-data">
          <i class="fas fa-clipboard-list" style="font-size: 48px; color: #d1d5db; margin-bottom: 15px;"></i><br>
          No emergency alerts yet...<br>
          <small>Emergency alerts will appear here in real-time</small>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Global variables
    let socket = null;
    let currentHospital = null;
    let emergencies = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Get current hospital from login
      try {
        currentHospital = JSON.parse(localStorage.getItem('currentUser'));
        if (currentHospital && currentHospital.category === 'hospital') {
          document.getElementById('hospitalName').textContent = currentHospital.hospitalName || currentHospital.name;
        } else {
          alert('Please login as a hospital first!');
          window.location.href = 'login.html';
          return;
        }
      } catch (e) {
        console.error('Error loading hospital data:', e);
        alert('Please login as a hospital first!');
        window.location.href = 'login.html';
        return;
      }

      // Initialize Socket.IO
      initializeSocket();
    });

    function initializeSocket() {
      socket = io();

      socket.on('connect', () => {
        console.log('Hospital connected to server:', socket.id);
        
        // Register as hospital
        socket.emit('registerHospital', {
          name: currentHospital.hospitalName || currentHospital.name,
          address: currentHospital.hospitalAddress || 'Not provided',
          license: currentHospital.hospitalLicense || 'Not provided',
          hospitalLocation: currentHospital.hospitalLocation || null,
          socketId: socket.id
        });
      });

      socket.on('hospitalRegistered', (data) => {
        console.log('Hospital registered successfully:', data);
        if (data.activeSOS) {
          emergencies = data.activeSOS;
          displayEmergencies();
        }
      });

      socket.on('newSOS', (sosData) => {
        console.log('New SOS received:', sosData);
        emergencies.unshift(sosData);
        displayEmergencies();
      });

      socket.on('sosAccepted', (data) => {
        console.log('SOS accepted:', data);
        let emergency = emergencies.find(e => e.sosId === data.sosId);
        
        // If emergency doesn't exist, create it from patient info
        if (!emergency && data.patientInfo) {
          emergency = {
            ...data.patientInfo,
            status: 'accepted',
            acceptedBy: data.driverName,
            acceptedAt: new Date(),
            nearbyHospitals: data.nearbyHospitals || []
          };
          emergencies.unshift(emergency);
        } else if (emergency) {
          emergency.status = 'accepted';
          emergency.acceptedBy = data.driverName;
          emergency.acceptedAt = new Date();
          emergency.nearbyHospitals = data.nearbyHospitals || [];
        }
        
        displayEmergencies();
      });

      // ✅ Listen for incoming patient notifications (this hospital is nearest)
      socket.on("incomingPatient", (data) => {
        console.log("🚑 Incoming patient notification received:", data);
        
        // Show incoming patient alert at the top
        showIncomingPatientAlert(data);
        
        // Also add to emergency list if not already there
        const existingEmergency = emergencies.find(e => e.sosId === data.sosId);
        if (!existingEmergency) {
          const emergencyData = {
            sosId: data.sosId,
            userName: data.patientName,
            userMobile: data.patientMobile,
            location: data.patientLocation,
            type: data.emergencyType || 'Emergency',
            time: new Date().toLocaleTimeString(),
            status: 'accepted',
            acceptedBy: data.driverName,
            isIncoming: true
          };
          emergencies.unshift(emergencyData);
          displayEmergencies();
        }
      });

      // 🔍 Add debugging for all socket events
      socket.onAny((eventName, ...args) => {
        console.log(`🔍 Socket Event Received: ${eventName}`, args);
      });

      socket.on('patientArrived', (data) => {
        console.log('Patient arrived:', data);
        const emergency = emergencies.find(e => e.sosId === data.sosId);
        if (emergency) {
          emergency.status = 'completed';
          emergency.completedAt = data.arrivalTime;
          emergency.hospital = data.hospital;
          displayEmergencies();
        }
      });

      socket.on('disconnect', () => {
        console.log('Hospital disconnected from server');
      });
    }

    // ✅ Function to show incoming patient notification
    function showIncomingPatientAlert(data) {
      console.log("Showing incoming patient alert:", data);
      
      // Get notification container
      const notificationContainer = document.getElementById('incomingPatientContainer');

      // Create notification card
      const notificationCard = document.createElement('div');
      notificationCard.className = 'incoming-patient-notification';
      notificationCard.innerHTML = `
        <div style="
          background: linear-gradient(135deg, #059669 0%, #047857 100%);
          color: white;
          padding: 20px;
          border-radius: 15px;
          box-shadow: 0 10px 30px rgba(5, 150, 105, 0.3);
          animation: slideInRight 0.5s ease-out;
          border-left: 4px solid #10b981;
        ">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">
              🚑 Incoming Patient Alert
            </h3>
            <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
              background: rgba(255,255,255,0.2);
              border: none;
              color: white;
              border-radius: 50%;
              width: 24px;
              height: 24px;
              cursor: pointer;
              font-size: 12px;
            ">✕</button>
          </div>
          <div style="font-size: 14px; line-height: 1.4;">
            <p style="margin: 0 0 8px 0; font-weight: 500;">
              🏥 <strong>Driver "${data.driverName}"</strong> bringing patient <strong>"${data.patientName}"</strong>
            </p>
            <div style="display: grid; gap: 4px; font-size: 13px; opacity: 0.9;">
              <div>📞 ${data.patientMobile || 'N/A'}</div>
              <div>🚨 ${data.emergencyType || 'Emergency'}</div>
              <div>📍 ${data.patientLocation || 'Location not available'}</div>
              <div>🛣️ Distance: ${data.distance || 'N/A'}</div>
              <div>⏱️ ${data.eta || 'On the way'}</div>
            </div>
          </div>
        </div>
      `;

      // Add to container
      notificationContainer.appendChild(notificationCard);

      // Auto-remove after 30 seconds
      setTimeout(() => {
        if (notificationCard && notificationCard.parentElement) {
          notificationCard.remove();
        }
      }, 30000);

      // Play notification sound
      playNotificationSound();
    }

    // ✅ Function to play notification sound
    function playNotificationSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (error) {
        console.log('Could not play notification sound:', error);
      }
    }

    function displayEmergencies() {
      const container = document.getElementById('emergenciesContainer');
      
      if (emergencies.length === 0) {
        container.innerHTML = `
          <div class="no-data">
            <i class="fas fa-clipboard-list" style="font-size: 48px; color: #d1d5db; margin-bottom: 15px;"></i><br>
            No emergency alerts yet...<br>
            <small>Emergency alerts will appear here in real-time</small>
          </div>
        `;
        return;
      }

      container.innerHTML = emergencies.map(emergency => {
        let hospitalDistanceHTML = '';
        if (emergency.nearbyHospitals && emergency.nearbyHospitals.length > 0) {
          hospitalDistanceHTML = `
            <div class="hospital-distance-info">
              <strong><i class="fas fa-hospital"></i> Nearest Hospitals & Distances for Ambulance Driver:</strong>
              <div class="hospital-distance-list">
                ${emergency.nearbyHospitals.map(hospital => 
                  `<span class="hospital-distance-item">${hospital.name}: ${hospital.distance.toFixed(1)} km</span>`
                ).join('')}
              </div>
            </div>
          `;
        }

        return `
          <div class="emergency-card ${emergency.status === 'accepted' ? 'accepted' : ''}">
            <div class="emergency-type">${emergency.type}</div>
            <div class="emergency-details">
              <div class="emergency-detail">
                <i class="fas fa-user"></i>
                <strong>Patient:</strong> ${emergency.userName || 'Anonymous'}
              </div>
              <div class="emergency-detail">
                <i class="fas fa-phone"></i>
                <strong>Mobile:</strong> ${emergency.userMobile || 'N/A'}
              </div>
              <div class="emergency-detail">
                <i class="fas fa-map-marker-alt"></i>
                <strong>Location:</strong> ${emergency.location}
              </div>
              <div class="emergency-detail">
                <i class="fas fa-clock"></i>
                <strong>Time:</strong> ${emergency.time}
              </div>
              <div class="emergency-detail">
                <i class="fas fa-info-circle"></i>
                <strong>Status:</strong> 
                <span class="status-badge ${emergency.status === 'pending' ? 'status-pending' : emergency.status === 'accepted' ? 'status-online' : 'status-completed'}">
                  ${emergency.status}
                </span>
              </div>
              ${emergency.acceptedBy ? `
                <div class="emergency-detail">
                  <i class="fas fa-ambulance"></i>
                  <strong>Driver:</strong> ${emergency.acceptedBy}
                </div>
              ` : ''}
              ${emergency.hospital ? `
                <div class="emergency-detail">
                  <i class="fas fa-hospital"></i>
                  <strong>Delivered to:</strong> ${emergency.hospital}
                </div>
              ` : ''}
            </div>
            ${hospitalDistanceHTML}
          </div>
        `;
      }).join('');
    }

    function filterEmergencies() {
      displayEmergencies(); // For now, just redisplay all emergencies
    }

    function refreshData() {
      console.log('Refreshing hospital dashboard data...');
      
      // Clear current emergencies and reload
      emergencies = [];
      displayEmergencies();
      
      // Request fresh data from server
      if (socket && socket.connected) {
        // Re-register hospital to get fresh active SOS data
        socket.emit('registerHospital', {
          name: currentHospital.hospitalName || currentHospital.name,
          address: currentHospital.hospitalAddress || 'Not provided',
          license: currentHospital.hospitalLicense || 'Not provided',
          hospitalLocation: currentHospital.hospitalLocation || null,
          socketId: socket.id
        });
        
        console.log('✅ Data refresh requested from server');
        
        // Show visual feedback
        const refreshBtn = event.target;
        const originalText = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        refreshBtn.style.opacity = '0.7';
        
        // Reset button after 2 seconds
        setTimeout(() => {
          refreshBtn.innerHTML = originalText;
          refreshBtn.style.opacity = '1';
        }, 2000);
      } else {
        alert('Not connected to server. Please check your connection.');
      }
    }

    // ✅ Test function to verify notification system
    function testNotification() {
      console.log("Testing notification system...");
      const testData = {
        sosId: 'test-123',
        patientName: 'Test Patient',
        patientMobile: '+1234567890',
        driverName: 'Test Driver',
        emergencyType: 'Heart Attack',
        patientLocation: 'Test Location, City',
        distance: '2.5 km',
        eta: 'Arriving in 10 minutes'
      };
      
      showIncomingPatientAlert(testData);
    }
  </script>
</body>
</html>